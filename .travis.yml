language: python
python: "3.6"
before_install:
  - pip install awscli
  - pip install aws-sam-cli
script:
  - export STACKNAME='CloudFormationVer4'
  - aws --version
  - sam --version
  - sam validate
  - sam build --use-container
  - sam package --output-template-file packaged.yml --s3-bucket cfb-game-of-the-week-zip-files
  - sam deploy --template-file packaged.yml --stack-name $STACKNAME --capabilities CAPABILITY_IAM --region us-east-1 --parameter-overrides DeploymentStage=Dev
  - echo "Updating script file..."
  - export APIURL=$(aws cloudformation describe-stacks --stack-name $STACKNAME --query Stacks[].Outputs[*].[OutputValue] --output text)
  - echo "const lambdaURL = '$APIURL'" > tmpfile
  - sed '1d' frontEnd/script.js >> tmpfile
  - rm frontEnd/script.js && mv tmpfile frontEnd/script.js
  - echo "The file script.js was updated."
  - cat frontEnd/script.js
  - echo "SUCCESS"
  - echo This build was pushed from branch ${TRAVIS_BRANCH}.
  - echo The API URL is $APIURL
# deploy:
#   - provider: script
#     skip_cleanup: true
#     script: sam deploy --template-file packaged.yml --stack-name CloudFormationVer4 --capabilities CAPABILITY_IAM --region us-east-1 --parameter-overrides DeploymentStage=Dev
#     on:
#       branch: travisUpdate
deploy:
  provider: s3
  bucket: "cfbgameoftheweek.com"
  skip_cleanup: true
  local-dir: frontEnd
  acl: public_read
  on:
    branch: travisUpdate